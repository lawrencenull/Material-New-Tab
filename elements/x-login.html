<dom-module id="x-login">

    <!-- ----------------------------------------------------------------------------------------------------------- -->
    <!-- CSS -->
    <style>

        :host { display: block; height: 100%; margin: 100px auto; width: 600px; }

        paper-material { background: white; padding: 10px 20px; }

        h2 { text-align: center; }

        p { text-align: justify; }
        p i { color: #999; }

        paper-tabs { --paper-tabs-selection-bar-color: #1E86BD; }
        neon-animated-pages { height: 300px; overflow: hidden; }
        neon-animated-pages section { padding: 20px; }

        div.spinner { margin: auto; text-align: center; }

    </style>

    <!-- ----------------------------------------------------------------------------------------------------------- -->
    <!-- HTML -->
    <template>
        <paper-material elevation="2">

            <!-- ------------------------------------------- -->
            <!-- Description -->
            <h2>Welcome to Material New Tab</h2>
            <p>
                Before we start, please create an account. This feature syncs basic settings of your extension, ensuring
                your data survives when you change computer or browser.
            </p>
            <p>
                <i>
                    This feature <strong>only syncs local data</strong>, such as RSS feed settings or Dashboard
                    configuration. Data from third party services (such as Google Calendar or Youtube) are only stored
                    locally and are never uploaded anywhere. Password Generator data are not synced at all.
                </i>
            </p>

            <!-- ------------------------------------------- -->
            <!-- Tabs -->
            <paper-tabs selected="{{tab}}" noink>
                <paper-tab>Register</paper-tab>
                <paper-tab>Login</paper-tab>
            </paper-tabs>

            <!-- ------------------------------------------- -->
            <!-- Pages -->
            <neon-animated-pages id="pages" selected="{{tab}}">

                <!-- Register section -->
                <section>

                    <!-- Spinner -->
                    <div hidden$="[[!registerLoading]]" class="spinner horizontal center-justified layout">
                        <paper-spinner active></paper-spinner>
                    </div>

                    <!-- Register form -->
                    <gold-email-input id="registerEmail" label="Email address"></gold-email-input>
                    <paper-input id="registerPassword" label="Password  (at least 5 characters)" type="password"></paper-input>
                    <paper-input id="registerPassword2" label="Repeat password" type="password"></paper-input>
                    <div class="horizontal center-justified layout">
                        <paper-button id="registerButton" on-click="doRegister" class="primary">Register</paper-button>
                    </div>

                </section>

                <!-- Login section -->
                <section>

                    <!-- Spinner -->
                    <div hidden$="[[!loginLoading]]" class="spinner horizontal center-justified layout">
                        <paper-spinner active></paper-spinner>
                    </div>

                    <!-- Login form -->
                    <gold-email-input id="loginEmail" label="Email address"></gold-email-input>
                    <paper-input id="loginPassword" label="Password" type="password" min="5"></paper-input>
                    <div class="horizontal center-justified layout">
                        <paper-button id="loginButton" on-click="doLogin" class="primary">Log in</paper-button>
                        <paper-button id="loginButton" on-click="doReset">Reset password</paper-button>
                    </div>

                </section>

            </neon-animated-pages>

            <!-- ------------------------------------------- -->
            <!-- Toast -->
            <paper-toast id="toast"></paper-toast>

        </paper-material>
    </template>

    <!-- ----------------------------------------------------------------------------------------------------------- -->
    <!-- Javascript -->
    <script>
        Polymer({

            /* ------------------------------------------------------------------------------------------------------ */
            /* Init */

            /**
             * Element initialization and properties definition.
             */
            is: 'x-login',
            properties: {
                tab: {
                    type: Number,
                    value: 0,
                    observer: '_tabChanged'
                },
                loginLoading: {
                    type: Boolean,
                    value: false
                },
                registerLoading: {
                    type: Boolean,
                    value: false
                },
            },

            /* ------------------------------------------------------------------------------------------------------ */
            /* Lifecycle callbacks */

            /**
             * Called when element is created.
             */
            created: function () {},

            /**
             * Called when element is attached to DOM.
             */
            attached: function () {},

            /**
             * Called when element is detached from DOM.
             */
            detached: function () {},

            /* ------------------------------------------------------------------------------------------------------ */
            /* Observers */

            /**
             * Change entry/exit animations based on currently selected tab.
             */
            _tabChanged: function (newValue) {
                if (newValue == 0) {
                    this.$.pages.entryAnimation = 'slide-from-right-animation';
                    this.$.pages.exitAnimation = 'slide-left-animation';
                } else {
                    this.$.pages.entryAnimation = 'slide-from-left-animation';
                    this.$.pages.exitAnimation = 'slide-right-animation';
                }
            },

            /* ------------------------------------------------------------------------------------------------------ */
            /* Event handlers */

            /**
             * Validate register form and register new user in Firebase database.
             */
            doRegister: function () {
                var valid = true;
                if (this.$.registerEmail.value == '' || !this.$.registerEmail.validate()) {
                    this.$.registerEmail.invalid = true;
                    this.$.registerEmail.$.input.focus();
                    valid = false;
                } else if (this.$.registerPassword.value == '' || this.$.registerPassword.value.length < 5) {
                    this.$.registerPassword.invalid = true;
                    this.$.registerPassword.$.input.focus();
                    valid = false;
                } else if (this.$.registerPassword2.value == '' || this.$.registerPassword2.value.length < 5) {
                    this.$.registerPassword2.invalid = true;
                    this.$.registerPassword2.$.input.focus();
                    valid = false;
                } else if (this.$.registerPassword.value != this.$.registerPassword2.value) {
                    this.$.registerPassword.invalid = true;
                    this.$.registerPassword2.invalid = true;
                    this.$.registerPassword.$.input.focus();
                    valid = false;
                } else {
                    this.$.registerPassword.invalid = false;
                    this.$.registerPassword.invalid = false;
                    this.$.registerPassword2.invalid = false;
                }
                if (valid) {
                    this.disableAllInputs();
                    this.registerLoading = true;
                    var that = this;
                    FIREBASE.get().createUser({
                        email: this.$.registerEmail.value,
                        password: this.$.registerPassword.value
                    }, function (error, userData) {
                        that.registerLoading = false;
                        that.enableAllInputs();
                        if (error) {
                            that.__toast('Ooops! ' + error);
                        } else {
                            that.$.loginEmail.value = that.$.registerEmail.value;
                            that.$.loginPassword.value = that.$.registerPassword.value;
                            that.$.registerEmail.value = that.$.registerPassword.value = that.$.registerPassword2.value = '';
                            that.tab = 1;
                            that.__toast('Registration successful, you can now log in with your email and password.');
                        }
                    });
                }
            },

            /**
             * Validate login form and login user into Firebase database.
             */
            doLogin: function () {
                var valid = true;
                if (this.$.loginEmail.value == '' || !this.$.loginEmail.validate()) {
                    this.$.loginEmail.invalid = true;
                    this.$.loginEmail.$.input.focus();
                    valid = false;
                } else if (this.$.loginPassword.value == '' || this.$.loginPassword.value.length < 5) {
                    this.$.loginPassword.invalid = true;
                    this.$.loginPassword.$.input.focus();
                    valid = false;
                } else {
                    this.$.loginEmail.invalid = false;
                    this.$.loginPassword.invalid = false;
                }
                if (valid) {
                    this.disableAllInputs();
                    this.loginLoading = true;
                    var that = this;
                    FIREBASE.get().authWithPassword({
                        email: this.$.loginEmail.value,
                        password: this.$.loginPassword.value
                    }, function (error, authData) {
                        that.loginLoading = false;
                        that.enableAllInputs();
                        if (error) {
                            this.__toast('Ooops! ' + error);
                        } else {
                            window.dispatchEvent(new CustomEvent('__userLogin'));
                        }
                    })
                }
            },

            /**
             * Validate email and submit reset password form.
             */
            doReset: function () {
                if (this.$.loginEmail.value == '' || !this.$.loginEmail.validate()) {
                    this.$.loginEmail.invalid = true;
                    this.$.loginEmail.$.input.focus();
                } else {
                    this.loginLoading = true;
                    var that = this;
                    FIREBASE.get().resetPassword({
                        email: this.$.loginEmail.value
                    }, function (error) {
                        that.loginLoading = false;
                        if (error) {
                            that.__toast('Oops! ' + error);
                        } else {
                            that.__toast('Instructions on how to reset your password have been sent to your email.');
                        }
                    })
                }
            },

            /* ------------------------------------------------------------------------------------------------------ */
            /* Helper functions */

            /**
             * Disables all inputs in both login an register forms.
             */
            disableAllInputs: function () {
                this.$.loginEmail.disabled = true;
                this.$.loginPassword.disabled = true;
                this.$.loginButton.disabled = true;
                this.$.registerEmail.disabled = true;
                this.$.registerPassword.disabled = true;
                this.$.registerPassword2.disabled = true;
                this.$.registerButton.disabled = true;
            },

            /**
             * Enables all inputs in both login an register forms.
             */
            enableAllInputs: function () {
                this.$.loginEmail.disabled = false;
                this.$.loginPassword.disabled = false;
                this.$.loginButton.disabled = false;
                this.$.registerEmail.disabled = false;
                this.$.registerPassword.disabled = false;
                this.$.registerPassword2.disabled = false;
                this.$.registerButton.disabled = false;
            },

            /**
             * Shows error message
             *
             * @param text
             * @private
             */
            __toast: function (text) {
                this.$.toast.text = text;
                this.$.toast.show();
            }

        });
    </script>

</dom-module>